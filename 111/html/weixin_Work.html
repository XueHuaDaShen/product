<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Access-Control-Allow-Origin" content="*"><!--解决资源跨域的策略-->
    <title>微信作业</title>
    <link rel="stylesheet" href="../css/weixin_Work.css">
    <script>window.PointerEvent = undefined</script><!--iscroll卡的现象-->
</head>
<body>


    <div class="wx_container wrapper" id="wx_container">
        <div class="wx_contain">
            <div class="wx_work">
                <header class="wx_header">
                    <div class="banner_Pic"><img src="../img/banner 2.png" alt=""></div>
                </header>


                <section class="wx_section">
                    <div class="signUp">
                        <button class="sign_up">我要报名</button>
                        <div class="wx_Sample">
                            <ul class="sample_ul">
                                <li><a href="javascript:;"><i>作业</i><span>243</span></a></li>
                                <li><a href="javascript:;"><i>作品数</i><span>243</span></a></li>
                                <li><a href="javascript:;"><i>最新作品</i><span>243</span></a></li>
                                <li><a href="javascript:;"><i>热门作品</i><span>243</span></a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="wx_cont" id="wx_cont">
                        <!--<ul class="cont_ul" id="cont_ul">
                            <li><a href="Works_details.html"><img src="../img/1.jpg" alt=""></a><h2 class="cont_title">饼干小人过新年</h2><span><i>445</i>人参与 作品<em>888</em></span></li>
                        </ul>-->
                    </div>
                </section>
            </div>
        </div>
    </div>
</body>
</html>
<script>
    document.documentElement.style.fontSize=document.documentElement.clientWidth/7.5+"px";
</script>
<script src="../js/jquery.js"></script>
<script src="../js/iscroll5.js"></script>
<script src="../js/refresh.js"></script>
<script src="../js/common.js"></script>
<script>
  
    var iscroll=new IScroll("#wx_container",{
        preventDefault:true,
        click:true
    });
    //我要报名
    $(".sign_up").on("click",function(){
       $(this).css({"outline":"none"});
        show_prompt()
    });
    function show_prompt(){
        var username = prompt('用户名：', '');
        var passwd = prompt('密码：', '');
        do_login(username,passwd)
    } 
	
		
	//检查登录状态
	var userId =localStorage.getItem("userId");
	if(null!=userId){
	  	var showName = localStorage.getItem("showName");
		if(null!=showName){
			$(".sign_up").text(showName); 
		} 
	}
	
    function do_login(username,passwd) {
        var loginUrl= BaseUrl +"/mobile/api/login";

        $.ajax({
            type: "GET",
            url: loginUrl,
            data: {
                account_type:"0",
                account: username,
                password:passwd
            },
            success: function (data) {
                if(data.success){
                    //alert(data.entity.showName);
                    //alert(data.entity.userId); 
					$(".sign_up").text(data.entity.showName);  
					localStorage.setItem("showName", data.entity.showName);
					localStorage.setItem("userId", data.entity.userId);
                }else{
                    alert(data.message);
					$(".sign_up").text(data.message); 
                }
            }
        });
    }


    //调用后台数据
    $.get(BaseUrl+"/images/work_list.json", function(data) {
	
        var data=data.questionsList;//数组  
        localStorage.setItem("worklist", data);
		
        var wx_str= '<ul class="cont_ul" id="cont_ul">';
        for(var i=0;i<data.length;i++){ 
		
		    if(i==0){
				localStorage.setItem("_work_title", data[i].title);
				localStorage.setItem("_work_id", data[i].id); 
			}
            var string=data[i].images[0];//压缩前的地址
            //截取最后的jpg或png
            var subStr=string.substring(string.length-4,string.length);
            var haveStr=string.substring(0,string.length-4);
            var newStr=haveStr+"_small"+subStr;//压缩后的地址
            wx_str+='<li title="'+data[i].title+'" id="'+data[i].id+'" ><img src="'+BaseUrl+newStr+'" alt=""/><h2 class="cont_title">'+data[i].title+'</h2><span><i>'+data[i].browseCount+'</i>人参与 作品<em>'+data[i].replyCount+'</em></span></li>';
        }
        wx_str+="</ul>";
        $("#wx_cont").append(wx_str);

        //本地存储：
        var obj={};
        window.localStorage.obj=JSON.stringify(obj);
        $("#cont_ul li").on("click",function(){
            $(this).css({
                "rgba":"(0,0,0,0.8)",
                "position":"absolute",
                "left":0,
                "top":0
            });
            var _title = $(this).attr("title");
            var _id = $(this).attr("id");
			
			localStorage.setItem("_work_title", _title);
			localStorage.setItem("_work_id", _id);
 
            location.href="Works_details.html";
        });
    });


    //上拉加载更多
    function load(){
        new Drop("wx_container",{
            load:function(that){
                setTimeout(function(){
                    $(".u_box").css("height",0).on("webkitTransitionEnd",function(){
                        $(this).remove();
                        that.isHave=false;
                        $.get(BaseUrl+"/images/work_list.json", function(e){
                            var e=e.questionsList;
                            loadPage(e);
                        })
                    });
                },1000);

            }
        });
        function loadPage(e){//加载数据
            var wx_str='<ul class="cont_ul" id="cont_ul">';
            for(var i=0;i<e.length;i++){
                var string=e[i].images[0];//压缩前的地址
                //截取最后的jpg或png
                var subStr=string.substring(string.length-4,string.length);
                var haveStr=string.substring(0,string.length-4);
                var newStr=haveStr+"_small"+subStr;//压缩后的地址
                wx_str+='<li><a href="javascript:;" data-title="'+e[i].title+'" data-id="'+e[i].cusId+'"><img src="'+BaseUrl+newStr+'" alt=""></a><h2 class="cont_title">'+e[i].title+'</h2><span><i>'+e[i].browseCount+'</i>人参与 作品<em>'+e[i].replyCount+'</em></span></li>';
            }
            wx_str+="</ul>";
            $("#wx_cont").append(wx_str);
            iscroll.refresh();

        }
    }

</script>
